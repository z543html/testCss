<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ECharts 3D饼图示例</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.0.2/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts-gl/2.0.4/echarts-gl.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        #chartR2 {
            width: 100%;
            height: 60vh;
            min-height: 400px;
            max-width: 800px;
            margin: 0 auto;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #0E3567;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
        }
        .screenshot-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 800px;
        }
        .screenshot-btn {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 12px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
            width: 100%;
            max-width: 200px;
        }
        .screenshot-btn:hover {
            background-color: #45a049;
        }
        .screenshot-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .result-container {
            margin-top: 20px;
            text-align: center;
            display: none;
            width: 100%;
        }
        #screenshotResult {
            max-width: 100%;
            max-height: 400px;
            border: 2px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .download-btn {
            background-color: #2196F3;
            border: none;
            color: white;
            padding: 10px 14px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
            width: 100%;
            max-width: 150px;
        }
        .download-btn:hover {
            background-color: #0b7dda;
        }
        .title {
            color: white;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
            padding: 0 10px;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 400px;
        }
        
        /* 媒体查询 - 平板和桌面设备 */
        @media (min-width: 768px) {
            #chartR2 {
                height: 600px;
            }
            .button-group {
                flex-direction: row;
                justify-content: center;
            }
            .screenshot-btn {
                width: auto;
            }
            .download-btn {
                width: auto;
            }
            .title {
                font-size: 2rem;
            }
        }
        
        /* 媒体查询 - 小屏幕手机 */
        @media (max-width: 480px) {
            #chartR2 {
                height: 50vh;
                min-height: 300px;
            }
            .screenshot-btn {
                padding: 10px 12px;
                font-size: 14px;
            }
            .title {
                font-size: 1.3rem;
            }
        }
        
        /* 防止文本选择 */
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <h1 class="title no-select">业务分布3D饼图</h1>
    <div id="chartR2" style="transform: scale(0.5);"></div>
    
    <div class="screenshot-container">
        <div class="button-group">
            <button id="screenshotBtn" class="screenshot-btn">截图保存</button>
            <button id="screenshotChartBtn" class="screenshot-btn">仅截图图表</button>
            <button id="screenshotCustomBtn" class="screenshot-btn">自定义截图</button>
        </div>
        
        <div class="result-container" id="resultContainer">
            <h3 style="color: white;">截图结果</h3>
            <img id="screenshotResult" alt="截图结果">
            <div style="display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 400px;">
                <button id="downloadBtn" class="download-btn">下载图片</button>
                <button id="newScreenshotBtn" class="download-btn">重新截图</button>
            </div>
        </div>
    </div>

    <script>
        // 初始化图表函数
        function initChartR2() {
            const chartDom = document.getElementById('chartR2');
            const rightChart2 = echarts.init(chartDom);
            
            // 生成扇形的曲面参数方程
            function getParametricEquation(startRatio, endRatio, isSelected, isHovered, k, height) {
                // 计算
                const midRatio = (startRatio + endRatio) / 2;
                const startRadian = startRatio * Math.PI * 2;
                const endRadian = endRatio * Math.PI * 2;
                const midRadian = midRatio * Math.PI * 2;
                
                // 如果只有一个扇形，则不实现选中效果
                if (startRatio === 0 && endRatio === 1) {
                    isSelected = false;
                }
                
                // 通过扇形内径/外径的值，换算出辅助参数k（默认值1/3）
                k = typeof k !== 'undefined' ? k : 1 / 3;
                
                // 计算选中效果分别在x轴、y轴方向上的位移（未选中，则位移均为0）
                const offsetX = isSelected ? Math.cos(midRadian) * 0.1 : 0;
                const offsetY = isSelected ? Math.sin(midRadian) * 0.1 : 0;
                
                // 计算高亮效果的放大比例（未高亮，则比例为1）
                const hoverRate = isHovered ? 1.05 : 1;
                
                // 返回曲面参数方程
                return {
                    u: {
                        min: -Math.PI,
                        max: Math.PI * 3,
                        step: Math.PI / 32
                    },
                    v: {
                        min: 0,
                        max: Math.PI * 2,
                        step: Math.PI / 20
                    },
                    x: function(u, v) {
                        if (u < startRadian) {
                            return offsetX + Math.cos(startRadian) * (1 + Math.cos(v) * k) * hoverRate;
                        }
                        if (u > endRadian) {
                            return offsetX + Math.cos(endRadian) * (1 + Math.cos(v) * k) * hoverRate;
                        }
                        return offsetX + Math.cos(u) * (1 + Math.cos(v) * k) * hoverRate;
                    },
                    y: function(u, v) {
                        if (u < startRadian) {
                            return offsetY + Math.sin(startRadian) * (1 + Math.cos(v) * k) * hoverRate;
                        }
                        if (u > endRadian) {
                            return offsetY + Math.sin(endRadian) * (1 + Math.cos(v) * k) * hoverRate;
                        }
                        return offsetY + Math.sin(u) * (1 + Math.cos(v) * k) * hoverRate;
                    },
                    z: function(u, v) {
                        if (u < -Math.PI * 0.5) {
                            return Math.sin(u);
                        }
                        if (u > Math.PI * 2.5) {
                            return Math.sin(u);
                        }
                        return Math.sin(v) > 0 ? 1 * height : -1;
                    }
                };
            }
            
            // 生成模拟3D饼图的配置项
            function getPie3D(pieData, internalDiameterRatio) {
                const series = [];
                let sumValue = 0;
                let startValue = 0;
                let endValue = 0;
                const k = typeof internalDiameterRatio !== 'undefined' 
                    ? (1 - internalDiameterRatio) / (1 + internalDiameterRatio) 
                    : 1 / 3;
                
                // 计算最大值，用于高度比例
                const maxValue = Math.max(...pieData.map(item => item.value));
                
                // 为每一个饼图数据，生成一个series-surface配置
                for (let i = 0; i < pieData.length; i++) {
                    sumValue += pieData[i].value;
                    
                    const seriesItem = {
                        name: typeof pieData[i].name === 'undefined' ? `series${i}` : pieData[i].name,
                        type: 'surface',
                        parametric: true,
                        wireframe: {
                            show: false
                        },
                        pieData: pieData[i],
                        pieStatus: {
                            selected: false,
                            hovered: false,
                            k: k
                        }
                    };
                    
                    if (typeof pieData[i].itemStyle !== 'undefined') {
                        const itemStyle = {};
                        
                        if (typeof pieData[i].itemStyle.color !== 'undefined') {
                            itemStyle.color = pieData[i].itemStyle.color;
                        }
                        if (typeof pieData[i].itemStyle.opacity !== 'undefined') {
                            itemStyle.opacity = pieData[i].itemStyle.opacity;
                        }
                        
                        seriesItem.itemStyle = itemStyle;
                    }
                    series.push(seriesItem);
                }
                
                // 计算每个扇形的起始和结束比例，并生成参数方程
                for (let i = 0; i < series.length; i++) {
                    endValue = startValue + series[i].pieData.value;
                    series[i].pieData.startRatio = startValue / sumValue;
                    series[i].pieData.endRatio = endValue / sumValue;
                    
                    // 根据值计算高度，值越大高度越高
                    const baseHeight = 1000; // 基础高度
                    const heightScale = 3; // 高度缩放比例
                    const height = baseHeight + (series[i].pieData.value / maxValue) * baseHeight * heightScale;
                    
                    series[i].parametricEquation = getParametricEquation(
                        series[i].pieData.startRatio,
                        series[i].pieData.endRatio,
                        false,
                        false,
                        k,
                        height  // 使用计算出的高度
                    );
                    
                    startValue = endValue;
                }
                
                return series;
            }
            
            // 饼图数据
            const optionsData = [
                {
                    name: '国际货代',
                    value: 13.87,
                    itemStyle: {
                        opacity: 0.5,
                        color: '#7bc35a'
                    }
                },
                {
                    name: '租赁业务',
                    value: 0.6,
                    itemStyle: {
                        opacity: 0.5,
                        color: '#2f97df'
                    }
                },
                {
                    name: '仓储装卸',
                    value: 9.53,
                    itemStyle: {
                        opacity: 0.5,
                        color: '#4268d6'
                    }
                },
                {
                    name: '干线运输',
                    value: 72.17,
                    itemStyle: {
                        opacity: 0.5,
                        color: '#d35e5f'
                    }
                },
                {
                    name: '配送业务',
                    value: 3.67,
                    itemStyle: {
                        opacity: 0.5,
                        color: '#c2c763'
                    }
                },
                {
                    name: '其他业务',
                    value: 0.17,
                    itemStyle: {
                        opacity: 0.5,
                        color: '#8fdffe'
                    }
                }
            ];
            
            // 处理数据（确保最小值）
            const processedData = optionsData.map(item => {
                if (item.value < 5) {
                    item.value = 5;
                }
                return item;
            });
            
            // 生成3D系列
            const series = getPie3D(processedData, 0.5);
            
            // 添加2D饼图用于显示标签
            series.push({
                name: 'pie2d',
                type: 'pie',
                label: {
                    opacity: 1,
                    position: 'outside',
                    fontSize: 12,
                    lineHeight: 20,
                    textStyle: {
                        fontSize: 12,
                        color: '#fff'
                    }
                },
                labelLine: {
                    length: 30,
                    length2: 30
                },
                minAngle: 10,
                startAngle: -50,
                clockwise: false,
                radius: ['0', '25%'],
                center: ['50%', '50%'],
                tooltip: {
                    show: false
                },
                data: optionsData.map(item => {
                    const newItem = {...item};
                    newItem.itemStyle = {...item.itemStyle, opacity: 0};
                    return newItem;
                })
            });
            
            // 配置项 - 适配移动端
            const option = {
                legend: {
                    show: false
                },
                animation: true,
                tooltip: {
                    formatter: function(params) {
                        // 修复：对于3D系列，数据存储在series.pieData中
                        if (params.seriesName !== 'pie2d') {
                            // 检查是否是3D系列（surface类型）
                            if (params.componentType === 'series' && params.componentSubType === 'surface') {
                                const value = params.series.pieData ? params.series.pieData.value : 'N/A';
                                return `${params.seriesName}<br/>
                                    <span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${params.color};"></span>
                                    ${value}%`;
                            }
                        }
                        return '';
                    },
                    textStyle: {
                        fontSize: 14
                    }
                },
                title: {
                    text: '业务分布3D饼图',
                    x: 'center',
                    top: '10',
                    textStyle: {
                        color: '#fff',
                        fontSize: window.innerWidth < 768 ? '18px' : '22px'
                    }
                },
                labelLine: {
                    show: true,
                    lineStyle: {
                        color: '#7BC0CB'
                    }
                },
                label: {
                    show: true,
                    position: 'outside',
                    formatter: '{b} \n{d}%',
                    textStyle: {
                        color: '#fff',
                        fontSize: window.innerWidth < 768 ? '10px' : '12px'
                    }
                },
                xAxis3D: {
                    min: -1,
                    max: 1
                },
                yAxis3D: {
                    min: -1,
                    max: 1
                },
                zAxis3D: {
                    min: -1,
                    max: 1
                },
                grid3D: {
                    show: false,
                    boxHeight: 0.01,
                    bottom: '50%',
                    viewControl: {
                        distance: window.innerWidth < 768 ? 200 : 300,
                        alpha: 35,
                        beta: 60,
                        autoRotate: false
                    }
                },
                series: series
            };
            
            // 设置配置项并渲染图表
            rightChart2.setOption(option);
            
            // 窗口大小变化时重新调整图表
            window.addEventListener('resize', function() {
                rightChart2.resize();
                // 更新字体大小和距离设置
                option.title.textStyle.fontSize = window.innerWidth < 768 ? '18px' : '22px';
                option.label.textStyle.fontSize = window.innerWidth < 768 ? '10px' : '12px';
                option.grid3D.viewControl.distance = window.innerWidth < 768 ? 200 : 300;
                rightChart2.setOption(option);
            });
            
            // 返回图表实例，以便后续操作
            return rightChart2;
        }
        
        // 截图功能
        function setupScreenshot() {
            const screenshotBtn = document.getElementById('screenshotBtn');
            const screenshotChartBtn = document.getElementById('screenshotChartBtn');
            const screenshotCustomBtn = document.getElementById('screenshotCustomBtn');
            const resultContainer = document.getElementById('resultContainer');
            const screenshotResult = document.getElementById('screenshotResult');
            const downloadBtn = document.getElementById('downloadBtn');
            const newScreenshotBtn = document.getElementById('newScreenshotBtn');
            
            let currentScreenshotUrl = null;
            
            // 截图整个页面
            screenshotBtn.addEventListener('click', function() {
                screenshotBtn.disabled = true;
                screenshotBtn.textContent = '截图中...';
                
                html2canvas(document.body, {
                    backgroundColor: '#0E3567',
                    scale: window.innerWidth < 768 ? 1 : 1.5,
                    useCORS: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    currentScreenshotUrl = imgData;
                    screenshotResult.src = imgData;
                    resultContainer.style.display = 'block';
                    
                    screenshotBtn.disabled = false;
                    screenshotBtn.textContent = '截图保存';
                    
                    // 滚动到结果区域
                    resultContainer.scrollIntoView({ behavior: 'smooth' });
                }).catch(error => {
                    console.error('截图失败:', error);
                    alert('截图失败，请重试');
                    screenshotBtn.disabled = false;
                    screenshotBtn.textContent = '截图保存';
                });
            });
            
            // 仅截图图表
            screenshotChartBtn.addEventListener('click', function() {
                screenshotChartBtn.disabled = true;
                screenshotChartBtn.textContent = '截图中...';
                
                const chartContainer = document.getElementById('chartR2');
                
                html2canvas(chartContainer, {
                    backgroundColor: '#0E3567',
                    scale: window.innerWidth < 768 ? 1 : 1.5,
                    useCORS: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    currentScreenshotUrl = imgData;
                    screenshotResult.src = imgData;
                    resultContainer.style.display = 'block';
                    
                    screenshotChartBtn.disabled = false;
                    screenshotChartBtn.textContent = '仅截图图表';
                    
                    // 滚动到结果区域
                    resultContainer.scrollIntoView({ behavior: 'smooth' });
                }).catch(error => {
                    console.error('截图失败:', error);
                    alert('截图失败，请重试');
                    screenshotChartBtn.disabled = false;
                    screenshotChartBtn.textContent = '仅截图图表';
                });
            });
            
            // 自定义截图 - 截取包含标题和图表的区域
            screenshotCustomBtn.addEventListener('click', function() {
                screenshotCustomBtn.disabled = true;
                screenshotCustomBtn.textContent = '截图中...';
                
                // 创建包含标题和图表的自定义区域
                const customArea = document.createElement('div');
                customArea.style.backgroundColor = '#0E3567';
                customArea.style.padding = '20px';
                customArea.style.borderRadius = '8px';
                customArea.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                customArea.style.width = '100%';
                customArea.style.maxWidth = '800px';
                
                // 克隆标题和图表
                const title = document.querySelector('.title').cloneNode(true);
                const chart = document.getElementById('chartR2').cloneNode(true);
                
                customArea.appendChild(title);
                customArea.appendChild(chart);
                
                // 添加到文档中但不显示
                customArea.style.position = 'absolute';
                customArea.style.left = '-9999px';
                document.body.appendChild(customArea);
                
                html2canvas(customArea, {
                    backgroundColor: '#0E3567',
                    scale: window.innerWidth < 768 ? 1 : 1.5,
                    useCORS: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    currentScreenshotUrl = imgData;
                    screenshotResult.src = imgData;
                    resultContainer.style.display = 'block';
                    
                    // 移除临时元素
                    document.body.removeChild(customArea);
                    
                    screenshotCustomBtn.disabled = false;
                    screenshotCustomBtn.textContent = '自定义截图';
                    
                    // 滚动到结果区域
                    resultContainer.scrollIntoView({ behavior: 'smooth' });
                }).catch(error => {
                    console.error('截图失败:', error);
                    alert('截图失败，请重试');
                    document.body.removeChild(customArea);
                    screenshotCustomBtn.disabled = false;
                    screenshotCustomBtn.textContent = '自定义截图';
                });
            });
            
            // 下载图片
            downloadBtn.addEventListener('click', function() {
                if (currentScreenshotUrl) {
                    const link = document.createElement('a');
                    link.download = '3D饼图截图.png';
                    link.href = currentScreenshotUrl;
                    link.click();
                }
            });
            
            // 重新截图
            newScreenshotBtn.addEventListener('click', function() {
                resultContainer.style.display = 'none';
                currentScreenshotUrl = null;
            });
        }
        
        // 页面加载完成后初始化图表和截图功能
        document.addEventListener('DOMContentLoaded', function() {
            const chartInstance = initChartR2();
            setupScreenshot();
        });
    </script>
</body>
</html>
